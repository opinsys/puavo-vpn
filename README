OVERVIEW

Puavo VPN is used to create administration VPN connections to client devices. 
When puavo-vpn-client package is installed, it uses the Puavo client 
certificates to create a VPN tunnel. VPN server information is read from
/etc/puavo/vpn/servers

For example:

1.2.3.4 443 tcp
1.2.3.5 443 tcp

This configuration means that puavo-vpn-client tries to open OpenVPN connection
to either 1.2.3.4 or 1.2.3.5 using TCP port 443. Both IPs and hostnames are 
allowed, but because DNS problems affect hostnames, IPs are preferred.

The server needs to be set up with the following configuration:






Because every client has an individual fqdn as its certificate name, the 
VPN server can setup DNS server to provide names for clients using dynamic 
addresses.



DETAILS

puavo-vpn-client has two Upstart jobs:

* puavo-vpn-dnsmasq
* puavo-vpn-client

puavo-vpn-dnsmasq automatically acts as a local DNS resolver. It runs dnsmasq 
and it conflicts with the dnsmasq run by NetworkManager. For this reason 
NetworkManager's dnsmasq needs to disabled (on laptops):

/etc/NetworkManager/NetworkManager.conf
------------------------------------------------------------------------------
[main]
plugins=ifupdown,keyfile
#dns=dnsmasq

[ifupdown]
managed=false
------------------------------------------------------------------------------

The need for puavo-vpn-dnsmasq comes from DNS redirections that 
puavo-vpn-client does. When the tunnel comes up, it requests PTR record for 
_service._vpn.<puavo top domain> from the VPN gateway address. If fully 
qualified hostnames are returned, dnsmasq is instructed to query those names 
from the VPN gateway address.

When OpenVPN tunnel comes up, script /usr/lib/puavo-vpn-client/runme
script is called. It runs scripts under /etc/puavo-vpn-client/scripts/route-up/ 
where puavo-vpn-dnsmasq script is located. It calls 
/usr/lib/puavo-vpn-client/set-servers --query-services that stores the redirect 
hostnames to file /run/puavo-vpn-client/services and send the information to 
dnsmasq through DBUS. After it dnsmasq has been setup, it calls 
/usr/lib/puavo-vpn-client/runme dns-up that runs scripts from 
/etc/puavo-vpn-client/scripts/dns-up/. This is needed because one cannot pass 
any traffic through the tunnel in route-up scripts and set-servers is run 
in the background for that reason.

set-servers is called also from /etc/NetworkManager/dispatcher.d/puavo-vpn-dnsmasq 
when a network goes up or down. This ensures that puavo-vpn-dnsmasq always 
has the correct upstream DNS server address(es). VPN gateway is not queried 
in this case and only cached entries are used.



Copyright Â© 2014 Opinsys Oy

This program is free software; you can redistribute it and/or modify it 
under the terms of the GNU General Public License as published by the 
Free Software Foundation; either version 2 of the License, or (at your 
option) any later version.

This program is distributed in the hope that it will be useful, but 
WITHOUT ANY WARRANTY; without even the implied warranty of 
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General 
Public License for more details.

You should have received a copy of the GNU General Public License along 
with this program; if not, write to the Free Software Foundation, Inc., 
51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
